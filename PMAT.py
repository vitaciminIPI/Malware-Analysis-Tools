import getopt
import sys
import hashlib
from getpass import getpass
import requests
import json

ARG1 = 0
ARG2 = False
isValidArgs = True
FILE_PATH = ""
CHECKSUM = False
ORIGINAL_HASH = "2C6D5BE488B96BB2D055D73B6CC8315531BAA927CEFDC4129935F08B60F2A71C"
MY_API = "3e7b7c1801535998c249f13d8bfe6b5739ffbc1eaeb4ffe26341f46812d4041e"

def getHelp():
    print("This is help message")
    sys.exit()
    
# check argument lenght
def checkArgs(args):
    global isValidArgs
    if len(args) < 1:
        print("Error")
        isValidArgs = False

def getFileHash(pathFile):
    try:
        with open(pathFile, 'rb') as f:
            data = f.read()
            md5 = hashlib.md5(data).hexdigest()
            sha1 = hashlib.sha1(data).hexdigest()
            sha256 = hashlib.sha256(data).hexdigest()
            return md5, sha1, sha256
    except FileNotFoundError as e:
        print(e)
        return ""

def getArgument():
    global ARG1, ARG2, CHECKSUM, isValidArgs, FILE_PATH
    
    try:
        args,_ = getopt.getopt(sys.argv[1:], "hc:bC:", ["help", "count=", "bool", "checksum="])
        checkArgs(args)
        for key, val in args:
            if key in ["-h", "--help"]:
                getHelp()
            elif key in ["-c", "--count"]:
                ARG1 = val
            elif key == "-b" or key == "--bool":
                ARG2 = True
            elif key in ["-C", "--checksum"]:
                CHECKSUM = True
                FILE_PATH = val
    except Exception:
        isValidArgs = False
        print("Error")
        getHelp()

def checksumVT(fileHash, clientAPIKey):
    # Inject Ransomware hash
    inject_hash = "db349b97c37d22f5ea1d1841e3c89eb4"
    if clientAPIKey:
        try:
            print("\\-->[*] SHA256 SUM : " + fileHash)
            url = "https://www.virustotal.com/api/v3/files/"+ inject_hash
            headers = {
                'x-apikey' : clientAPIKey
            }
            response = requests.get(url, headers=headers)
            json_resp = json.loads(response.text)
            # print(response.text)
            # print(json_resp)
            print(json_resp['data']['attributes']['trid'][0]['file_type'])
        except:
            print("[!] Something's went wrong")
    else:
        print('[!] Please input your VirusTotal API key!')
        sys.exit()


def main():
    getArgument()
    if not isValidArgs:
        sys.exit()
    else:
        if CHECKSUM :
            print("[!] Getting File Hashes. . .")
            md5Hash, sha1Hash, sha256Hash = getFileHash(FILE_PATH)
            print("\\--> [*] MD5 : " + md5Hash)
            print("\\--> [*] SHA-1 : " + sha1Hash)
            print("\\--> [*] SHA-256 : " + sha256Hash)
            # if sha256Hash == ORIGINAL_HASH.lower():
            #     print("yeyyea")
            # else:
            #     print("aww helnah")
            isContinueToVt = input('Do you want to check in VirusTotal? [N|Y] ')

            if isContinueToVt == 'Y':
                clientAPIKey = getpass("Enter Your API Key: ")
                # clientAPIKey = input('Enter Your API Key: ')
                # session.headers = {
                #     'x-apikey' : clientAPIKey
                # }
                print('[*] Forwarding to VirusTotal...')
                checksumVT(sha256Hash, clientAPIKey)
            else:
                sys.exit()

if __name__ == "__main__":
    main()